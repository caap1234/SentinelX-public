---
const API_BASE = import.meta.env.PUBLIC_API_URL || "http://127.0.0.1:8000"
---

<div class="rounded-xl bg-white border border-[#E5E7EB] p-6 shadow-sm">
  <div class="text-center mb-5">
    <h2 class="text-sm font-semibold text-[#111827]">Incidentes recientes</h2>
    <p class="text-xs text-[#6B7280] mt-1">
      Últimos incidentes detectados (agrupados) en todos los servidores
    </p>
  </div>

  <div class="overflow-x-auto">
    <table class="min-w-full text-xs">
      <thead>
        <tr class="text-[#6B7280] border-b border-[#E5E7EB]">
          <th class="py-3 px-2 text-center">Severidad</th>
          <th class="py-3 px-2 text-left">Incidente</th>
          <th class="py-3 px-2 text-center">IP / Servidor</th>
          <th class="py-3 px-2 text-center">Fecha</th>
        </tr>
      </thead>

      <tbody class="text-[#4B5563]" data-incidents-body>
        <!-- Filas desde JSON -->
      </tbody>
    </table>
  </div>

  <script type="module" define:vars={{ API_BASE }}>
    const tbody = document.querySelector("[data-incidents-body]");

    // @ts-ignore
    const TOKEN = window.SENTINELX_TOKEN || null;

    const COLORS = {
      high: "#C0392B",
      medium: "#F0B400",
      low: "#22C55E",
    };

    const severityWeight = (level) => {
      if (level === "high") return 2;
      if (level === "medium") return 1;
      return 0;
    };

    function getInitialFilters() {
      // @ts-ignore
      return (
        window.SENTINELX_CURRENT_FILTERS || {
          server: "all",
          dateRange: "7d",
          severity: "all",
          rangeFrom: null,
          rangeTo: null,
        }
      );
    }

    /**
     * @param {{server:string; dateRange:string; severity:string; rangeFrom?:string|null; rangeTo?:string|null}} filters
     */
    function buildQueryParams(filters) {
      const params = new URLSearchParams();

      if (filters.server && filters.server !== "all") {
        params.set("server", filters.server);
      }

      if (filters.dateRange === "1d") params.set("days", "1");
      else if (filters.dateRange === "7d") params.set("days", "7");
      else if (filters.dateRange === "30d") params.set("days", "30");
      else params.set("days", "7");

      if (filters.severity && filters.severity !== "all") {
        params.set("severity", filters.severity);
      }

      // ✅ SOLO PENDIENTES
      params.set("status", "open");

      params.set("limit", "20");
      params.set("offset", "0");
      return params;
    }

    function renderIncidents(raw) {
      if (!tbody) return;
      tbody.innerHTML = "";

      if (!Array.isArray(raw) || raw.length === 0) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 4;
        td.className = "py-4 px-2 text-center text-[11px] text-[#9CA3AF]";
        td.textContent = "Sin incidentes recientes en este periodo.";
        tr.append(td);
        tbody.append(tr);
        return;
      }

      const rows = raw
        .map((i) => {
          const level = (i.level || "low").toLowerCase();
          const severityLabel = i.severityLabel || (level === "high" ? "Alta" : level === "medium" ? "Media" : "Baja");

          let datetime = "—";
          if (i.datetime) {
            const d = new Date(i.datetime);
            if (!Number.isNaN(d.getTime())) {
              const pad = (n) => String(n).padStart(2, "0");
              datetime = `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
            }
          }

          return {
            level,
            severityLabel,
            type: i.type || "Incidente",
            description: i.description || "",
            ip: i.ip || "—",
            server: i.server || "Servidor",
            datetime,
          };
        })
        .sort((a, b) => {
          const dateA = new Date(a.datetime !== "—" ? a.datetime.replace(" ", "T") : 0);
          const dateB = new Date(b.datetime !== "—" ? b.datetime.replace(" ", "T") : 0);
          if (dateB.getTime() !== dateA.getTime()) return dateB.getTime() - dateA.getTime();
          return severityWeight(b.level) - severityWeight(a.level);
        })
        .slice(0, 5);

      rows.forEach((ev) => {
        const tr = document.createElement("tr");
        tr.className = "border-b border-[#F3F4F6]";

        const tdSeverity = document.createElement("td");
        tdSeverity.className = "py-3 px-2 text-center whitespace-nowrap";

        const sevWrapper = document.createElement("div");
        sevWrapper.className = "inline-flex items-center gap-2 px-3 py-1 rounded-full bg-[#F9FAFB]";

        const dot = document.createElement("span");
        dot.className = "h-2.5 w-2.5 rounded-full";
        dot.style.backgroundColor = COLORS[ev.level] || "#C0392B";

        const sevText = document.createElement("span");
        sevText.className = "text-[11px] font-medium";
        sevText.textContent = ev.severityLabel;

        sevWrapper.append(dot, sevText);
        tdSeverity.append(sevWrapper);

        const tdEvent = document.createElement("td");
        tdEvent.className = "py-3 px-2 text-left align-top leading-tight";

        const typeLine = document.createElement("div");
        typeLine.className = "text-[12px] font-semibold text-[#111827]";
        typeLine.textContent = ev.type;

        const descLine = document.createElement("div");
        descLine.className = "mt-0.5 text-[11px] text-[#6B7280]";
        const maxLen = 80;
        descLine.textContent =
          ev.description.length > maxLen ? ev.description.slice(0, maxLen) + "…" : (ev.description || "Sin descripción.");

        tdEvent.append(typeLine, descLine);

        const tdIpServer = document.createElement("td");
        tdIpServer.className = "py-3 px-2 text-center whitespace-nowrap leading-tight";

        const ipLine = document.createElement("div");
        ipLine.className = "text-[11px] font-medium text-[#111827]";
        ipLine.textContent = ev.ip;

        const serverLine = document.createElement("div");
        serverLine.className = "text-[11px] text-[#6B7280]";
        serverLine.textContent = ev.server;

        tdIpServer.append(ipLine, serverLine);

        const tdDate = document.createElement("td");
        tdDate.className = "py-3 px-2 text-center text-[11px] whitespace-nowrap";
        tdDate.textContent = ev.datetime;

        tr.append(tdSeverity, tdEvent, tdIpServer, tdDate);
        tbody.append(tr);
      });
    }

    async function loadRecentIncidents(filters) {
      if (!tbody) return;
      const params = buildQueryParams(filters);

      try {
        const res = await fetch(`${API_BASE}/dashboard/incidents/recent?${params.toString()}`, {
          headers: TOKEN
            ? { Authorization: `Bearer ${TOKEN}`, Accept: "application/json" }
            : { Accept: "application/json" },
        });

        if (!res.ok) {
          console.error("Error cargando /incidents:", await res.text());
          renderIncidents([]);
          return;
        }

        const data = await res.json();
        renderIncidents(data.items || []);
      } catch (err) {
        console.error("Error llamando /incidents:", err);
        renderIncidents([]);
      }
    }

    loadRecentIncidents(getInitialFilters());

    window.addEventListener("sentinelx:filters-changed", (ev) => {
      // @ts-ignore
      const filters = ev.detail;
      loadRecentIncidents(filters);
    });
  </script>
</div>
