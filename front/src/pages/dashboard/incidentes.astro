---
import DashboardLayout from "../../layouts/DashboardLayout.astro";
import HeaderBar from "../../components/dashboard/HeaderBar.astro";

const API_BASE = import.meta.env.PUBLIC_API_URL || "http://127.0.0.1:8000";
---

<DashboardLayout pageTitle="SentinelX SIEM – Incidentes Detectados">
  <HeaderBar
    title="Incidentes Detectados"
    subtitle="Lista de incidentes generados por correlación y agrupación de alertas."
    showFilters={true}
    showServerFilter={true}
    showDateFilter={true}
    showSeverityFilter={true}
  />

  <section class="flex-1 px-8 py-6 space-y-6">
    <!-- KPIs -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
      <div class="rounded-xl bg-white border border-[#E5E7EB] px-5 py-4 shadow-sm">
        <p class="text-[11px] uppercase tracking-wide text-[#9CA3AF]">Incidentes en la vista actual</p>
        <p class="mt-2 text-2xl font-semibold text-[#111827]" data-kpi-total-events>0</p>
      </div>

      <div class="rounded-xl bg-white border border-[#E5E7EB] px-5 py-4 shadow-sm">
        <p class="text-[11px] uppercase tracking-wide text-[#9CA3AF]">Score alto (61–100)</p>
        <p class="mt-2 text-2xl font-semibold text-[#111827]" data-kpi-critical>0</p>
      </div>

      <div class="rounded-xl bg-white border border-[#E5E7EB] px-5 py-4 shadow-sm">
        <p class="text-[11px] uppercase tracking-wide text-[#9CA3AF]">Pendientes por revisar</p>
        <p class="mt-2 text-2xl font-semibold text-[#111827]" data-kpi-pending>0</p>
      </div>

      <div class="rounded-xl bg-white border border-[#E5E7EB] px-5 py-4 shadow-sm">
        <p class="text-[11px] uppercase tracking-wide text-[#9CA3AF]">Falsos positivos</p>
        <p class="mt-2 text-2xl font-semibold text-[#111827]" data-kpi-false-positive>0</p>
      </div>
    </div>

    <!-- Filtro por estatus -->
    <div class="flex flex-wrap items-center gap-2">
      <span class="text-[11px] uppercase tracking-wide text-[#9CA3AF] mr-1">Filtrar por estatus:</span>

      <button type="button"
        class="px-3 py-1 rounded-full text-[11px] border border-[#E5E7EB] bg-white text-[#374151] hover:bg-[#F9FAFB]"
        data-incident-status-filter="all">Todos</button>

      <button type="button"
        class="px-3 py-1 rounded-full text-[11px] border border-[#E5E7EB] bg-white text-[#374151] hover:bg-[#F9FAFB]"
        data-incident-status-filter="open">Pendientes</button>

      <button type="button"
        class="px-3 py-1 rounded-full text-[11px] border border-[#E5E7EB] bg-white text-[#374151] hover:bg-[#F9FAFB]"
        data-incident-status-filter="resolved">Resueltos</button>

      <button type="button"
        class="px-3 py-1 rounded-full text-[11px] border border-[#E5E7EB] bg-white text-[#374151] hover:bg-[#F9FAFB]"
        data-incident-status-filter="false_positive">Falsos positivos</button>
    </div>

    <!-- Tabla -->
    <div class="rounded-xl bg-white border border-[#E5E7EB] px-8 py-5 shadow-sm">
      <div class="overflow-x-auto overflow-y-visible relative">
        <table class="min-w-full text-xs">
          <thead>
            <tr class="text-[#6B7280] border-b border-[#E5E7EB]">
              <th class="py-3 px-3 text-center">Score</th>
              <th class="py-3 px-3 text-center">Tipo</th>
              <th class="py-3 px-3 text-center">Entidad</th>
              <th class="py-3 px-3 text-center">Descripción</th>
              <th class="py-3 px-3 text-center">Servidor</th>
              <th class="py-3 px-3 text-center">Fecha</th>
              <th class="py-3 px-3 text-center">Estado</th>
              <th class="py-3 px-3 text-center">Acción</th>
            </tr>
          </thead>

          <tbody class="text-[#4B5563]" data-events-body></tbody>
        </table>
      </div>

      <!-- Paginación -->
      <div class="flex items-center justify-between mt-4">
        <button class="inline-flex items-center px-4 py-2 rounded-full border border-[#D1D5DB] text-[12px] text-[#374151] hover:bg-[#F3F4F6]"
          type="button" data-prev>Anterior</button>

        <div class="flex flex-wrap gap-1 justify-center" data-pagination></div>

        <button class="inline-flex items-center px-4 py-2 rounded-full border border-[#D1D5DB] text-[12px] text-[#374151] hover:bg-[#F3F4F6]"
          type="button" data-next>Siguiente</button>
      </div>
    </div>
  </section>

  <!-- Modal detalle -->
  <div id="incident-detail-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/40" data-incident-modal-backdrop>
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-4xl max-h-[85vh] flex flex-col border border-[#E5E7EB]">
      <div class="flex items-center justify-between px-5 py-3 border-b border-[#E5E7EB]">
        <div>
          <p class="text-xs uppercase tracking-wide text-[#9CA3AF]">Detalle del incidente</p>
          <p class="text-sm font-semibold text-[#111827]" data-incident-modal-title>—</p>
        </div>
        <button type="button" data-incident-modal-close class="h-7 w-7 rounded-full flex items-center justify-center hover:bg-[#F3F4F6]">
          <span class="text-sm text-[#6B7280]">✕</span>
        </button>
      </div>

      <div class="px-5 py-3 flex flex-wrap gap-4 text-[11px] text-[#6B7280]" data-incident-modal-summary></div>

      <div class="px-5 pb-4 overflow-y-auto space-y-4" data-incident-modal-body></div>

      <div class="px-5 py-3 border-t border-[#E5E7EB] flex items-center justify-end">
        <button type="button" class="inline-flex items-center px-4 py-2 rounded-lg border border-[#D1D5DB] text-[12px] text-[#374151] hover:bg-[#F3F4F6]" data-incident-modal-close>
          Cerrar
        </button>
      </div>
    </div>
  </div>

  <!-- Modal resolver -->
  <div id="incident-resolve-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/40" data-incident-resolve-backdrop>
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-xl border border-[#E5E7EB]">
      <div class="flex items-center justify-between px-5 py-3 border-b border-[#E5E7EB]">
        <div>
          <p class="text-xs uppercase tracking-wide text-[#9CA3AF]">Actualizar estatus del incidente</p>
          <p class="text-sm font-semibold text-[#111827]" data-incident-resolve-title>—</p>
        </div>
        <button type="button" class="h-7 w-7 rounded-full flex items-center justify-center hover:bg-[#F3F4F6]" data-incident-resolve-close>
          <span class="text-sm text-[#6B7280]">✕</span>
        </button>
      </div>

      <div class="px-5 py-4 space-y-4">
        <div>
          <label class="block text-[11px] text-[#6B7280] mb-1">Estatus</label>
          <select class="w-full rounded-lg border border-[#D1D5DB] px-3 py-2 text-[12px] text-[#111827] bg-white" data-incident-resolve-status>
            <option value="resolved">Resuelto</option>
            <option value="false_positive">Falso positivo</option>
            <option value="open">Abierto</option>
          </select>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <div>
            <label class="block text-[11px] text-[#6B7280] mb-1">Categoría (opcional)</label>
            <select class="w-full rounded-lg border border-[#D1D5DB] px-3 py-2 text-[12px] text-[#111827] bg-white" data-incident-resolve-category>
              <option value="" selected>—</option>
              <option value="bot">Bot</option>
              <option value="ddos">DDoS</option>
              <option value="spam">Spam</option>
              <option value="scanning">Escaneo</option>
              <option value="web_abuse">Abuso web</option>
              <option value="mail_abuse">Abuso correo</option>
              <option value="brute_force">Fuerza bruta</option>
              <option value="other">Otro</option>
            </select>
          </div>

          <div>
            <label class="block text-[11px] text-[#6B7280] mb-1">Disposición (opcional)</label>
            <select class="w-full rounded-lg border border-[#D1D5DB] px-3 py-2 text-[12px] text-[#111827] bg-white" data-incident-resolve-disposition>
              <option value="" selected>—</option>
              <option value="informational">Informativo</option>
              <option value="benign">Benigno</option>
              <option value="true_positive">Positivo real</option>
              <option value="mitigated">Mitigado</option>
              <option value="needs_followup">Requiere seguimiento</option>
            </select>
          </div>
        </div>

        <div>
          <label class="block text-[11px] text-[#6B7280] mb-1">Nota (opcional)</label>
          <textarea rows="3" class="w-full rounded-lg border border-[#D1D5DB] px-3 py-2 text-[12px] text-[#111827]"
            placeholder="Notas..." data-incident-resolve-note></textarea>
        </div>
      </div>

      <div class="px-5 py-3 border-t border-[#E5E7EB] flex items-center justify-end gap-2">
        <button type="button" class="inline-flex items-center px-4 py-2 rounded-lg border border-[#D1D5DB] text-[12px] text-[#374151] hover:bg-[#F3F4F6]" data-incident-resolve-close>
          Cancelar
        </button>
        <button type="button" class="inline-flex items-center px-4 py-2 rounded-lg bg-[#111827] text-white text-[12px] hover:bg-[#1F2937]"
          data-incident-resolve-save>Continuar</button>
      </div>
    </div>
  </div>

  <!-- Modal bloqueado (obligatorio) -->
  <div id="incident-blocked-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/40" data-incident-blocked-backdrop>
    <div class="bg-white rounded-2xl shadow-xl w-full max-w-xl border border-[#E5E7EB]">
      <div class="flex items-center justify-between px-5 py-3 border-b border-[#E5E7EB]">
        <div>
          <p class="text-xs uppercase tracking-wide text-[#9CA3AF]">No se puede cerrar aún</p>
          <p class="text-sm font-semibold text-[#111827]" data-incident-blocked-title>—</p>
        </div>
        <button type="button" class="h-7 w-7 rounded-full flex items-center justify-center hover:bg-[#F3F4F6]" data-incident-blocked-close>
          <span class="text-sm text-[#6B7280]">✕</span>
        </button>
      </div>

      <div class="px-5 py-4 space-y-3 text-[12px] text-[#374151]">
        <p data-incident-blocked-msg>—</p>

        <div class="rounded-lg border border-[#E5E7EB] bg-[#F9FAFB] px-4 py-3 text-[11px] text-[#6B7280]">
          <div><span class="font-semibold text-[#111827]" data-blocked-open-alerts>0</span> alertas abiertas</div>
          <div><span class="font-semibold text-[#111827]" data-blocked-open-entities>0</span> entidades abiertas</div>
        </div>

        <div class="flex flex-wrap gap-2 pt-1">
          <button type="button" class="inline-flex items-center px-4 py-2 rounded-lg bg-[#111827] text-white text-[12px] hover:bg-[#1F2937]"
            data-blocked-cascade>
            Cerrar en cascada
          </button>

          <button type="button" class="inline-flex items-center px-4 py-2 rounded-lg border border-[#D1D5DB] text-[12px] text-[#374151] hover:bg-[#F3F4F6]"
            data-blocked-go-alerts>
            Ver alertas relacionadas
          </button>

          <button type="button" class="inline-flex items-center px-4 py-2 rounded-lg border border-[#D1D5DB] text-[12px] text-[#374151] hover:bg-[#F3F4F6]"
            data-blocked-go-entities>
            Ver entidades relacionadas
          </button>
        </div>

        <p class="text-[11px] text-[#6B7280]">
          El incidente permanecerá abierto hasta que todas las alertas y entidades queden cerradas.
        </p>
      </div>

      <div class="px-5 py-3 border-t border-[#E5E7EB] flex items-center justify-end">
        <button type="button" class="inline-flex items-center px-4 py-2 rounded-lg border border-[#D1D5DB] text-[12px] text-[#374151] hover:bg-[#F3F4F6]"
          data-incident-blocked-close>
          Cerrar
        </button>
      </div>
    </div>
  </div>

  <script type="module" define:vars={{ API_BASE }}>
    // @ts-ignore
    const TOKEN = window.SENTINELX_TOKEN || null;

    const tbody = document.querySelector("[data-events-body]");
    const LIMIT = 50;
    const pagination = document.querySelector("[data-pagination]");
    const prevBtn = document.querySelector("[data-prev]");
    const nextBtn = document.querySelector("[data-next]");

    let state = { page: 1, total: 0, pages: 1 };

    /**
     * @typedef {{
     *   id:string,
     *   score:number,
     *   badge:"low"|"medium"|"high",
     *   type:string,
     *   entityText:string,
     *   description:string,
     *   server:string,
     *   datetimeISO:string,
     *   datetimeText:string,
     *   status:"open"|"resolved"|"false_positive"
     * }} IncidentRow
     */

    /** @type {IncidentRow[]} */
    let allRows = [];
    /** @type {IncidentRow[]} */
    let currentFilteredRows = [];

    // ✅ por defecto: pendientes (open)
    let activeFilters = {
      server: "all",
      dateRange: "7d",
      severity: "all",
      status: "open", // ✅ antes: "all"
      rangeFrom: null,
      rangeTo: null,
    };

    // ✅ Badges por score: azul/amarillo/rojo
    const SCORE_BADGE_CLASSES = {
      low: "bg-[#DBEAFE] text-[#1D4ED8]",      // azul 0-30
      medium: "bg-[#FEF3C7] text-[#92400E]",   // amarillo 31-60
      high: "bg-[#FEE2E2] text-[#B91C1C]",     // rojo 61-100
    };

    const STATUS_BADGE_CLASSES = {
      open: "bg-[#FEF3C7] text-[#92400E]",
      resolved: "bg-[#DCFCE7] text-[#166534]",
      false_positive: "bg-[#E5E7EB] text-[#374151]",
    };

    const STATUS_LABEL = {
      open: "Pendiente",
      resolved: "Resuelto",
      false_positive: "Falso positivo",
    };

    const authHeaders = () =>
      TOKEN
        ? { Authorization: `Bearer ${TOKEN}`, Accept: "application/json" }
        : { Accept: "application/json" };

    const scoreBadge = (score) => {
      const n = Number(score || 0);
      if (n >= 61) return "high";
      if (n >= 31) return "medium";
      return "low";
    };

    const normalizeIncident = (x) => {
      const id = String(x.id);
      const code = String(x.code || "INC");
      const name = String(x.name || "");
      const server = String(x.server || "—");
      const status = (x.status || "open");

      const score = Number(x.score || 0);
      const badge = scoreBadge(score);

      const et = String(x.primary_entity_type || "");
      const ek = String(x.primary_entity_key || "—");
      const entityText = et ? (et === "ip" ? ek : `${et}:${ek}`) : ek;

      const dtISO = x.last_activity_at || x.opened_at || x.updated_at || "";
      const dt = dtISO ? new Date(dtISO) : null;
      const datetimeText = dt && !isNaN(dt.getTime())
        ? dt.toLocaleString("es-MX", { dateStyle: "short", timeStyle: "short" })
        : "—";

      return {
        id,
        score,
        badge,
        type: code,
        entityText,
        description: name,
        server,
        datetimeISO: dtISO || "",
        datetimeText,
        status,
      };
    };

    const renderKpis = (rows) => {
      const totalEl = document.querySelector("[data-kpi-total-events]");
      const criticalEl = document.querySelector("[data-kpi-critical]");
      const pendingEl = document.querySelector("[data-kpi-pending]");
      const falsePosEl = document.querySelector("[data-kpi-false-positive]");

      if (totalEl) totalEl.textContent = String(rows.length);
      if (criticalEl) criticalEl.textContent = String(rows.filter((x) => x.badge === "high").length);
      if (pendingEl) pendingEl.textContent = String(rows.filter((x) => x.status === "open").length);
      if (falsePosEl) falsePosEl.textContent = String(rows.filter((x) => x.status === "false_positive").length);
    };

    const closeAllActionMenus = () => {
      document.querySelectorAll('[data-action-menu="row"]').forEach((menu) => menu.classList.add("hidden"));
    };

    const renderTable = (rowsPage) => {
      if (!tbody) return;
      tbody.innerHTML = "";

      if (!rowsPage.length) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 8;
        td.className = "py-6 text-center text-[11px] text-[#9CA3AF]";
        td.textContent = "Sin incidentes para estos filtros.";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      rowsPage.forEach((x) => {
        const tr = document.createElement("tr");
        tr.className = "border-b border-[#F3F4F6]";

        // Score badge
        const tdScore = document.createElement("td");
        tdScore.className = "py-4 px-3 text-center";
        const badge = document.createElement("span");
        badge.className =
          "inline-flex items-center justify-center px-3 py-1 rounded-full text-[12px] font-medium " +
          (SCORE_BADGE_CLASSES[x.badge] || SCORE_BADGE_CLASSES.low);
        badge.textContent = String(x.score);
        tdScore.appendChild(badge);

        const tdType = document.createElement("td");
        tdType.className = "py-4 px-3 text-center text-sm font-semibold";
        tdType.textContent = x.type;

        const tdEntity = document.createElement("td");
        tdEntity.className = "py-4 px-3 text-center whitespace-nowrap";
        tdEntity.textContent = x.entityText;

        const tdDesc = document.createElement("td");
        tdDesc.className = "py-4 px-3 text-center text-[11px] text-[#6B7280]";
        tdDesc.textContent = x.description;

        const tdServer = document.createElement("td");
        tdServer.className = "py-4 px-3 text-center";
        tdServer.textContent = x.server;

        const tdDate = document.createElement("td");
        tdDate.className = "py-4 px-3 text-center text-[11px] whitespace-nowrap";
        tdDate.textContent = x.datetimeText;

        const tdStatus = document.createElement("td");
        tdStatus.className = "py-4 px-3 text-center";
        const st = document.createElement("span");
        st.className =
          "inline-flex items-center justify-center px-3 py-1 rounded-full text-[11px] font-medium " +
          (STATUS_BADGE_CLASSES[x.status] || STATUS_BADGE_CLASSES.open);
        st.textContent = STATUS_LABEL[x.status] || "Pendiente";
        tdStatus.appendChild(st);

        const tdAction = document.createElement("td");
        tdAction.className = "py-4 px-3 text-center relative";

        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "inline-flex items-center justify-center h-6 w-6 rounded-full hover:bg-[#F3F4F6]";
        btn.setAttribute("aria-label", "Acciones");
        btn.dataset.actionTrigger = "row";

        const img = document.createElement("img");
        img.src = "/svg/accion.svg";
        img.alt = "Acciones";
        img.className = "h-3 w-3";
        img.loading = "lazy";
        btn.appendChild(img);

        const menu = document.createElement("div");
        menu.className =
          "hidden absolute right-3 top-9 w-56 rounded-lg bg-white border border-[#E5E7EB] shadow-lg text-xs text-left z-50";
        menu.dataset.actionMenu = "row";
        menu.innerHTML = `
          <button type="button" class="w-full text-left px-4 py-2.5 hover:bg-[#F9FAFB]" data-menu-action="detail" data-id="${x.id}">
            Ver detalle
          </button>
          <div class="my-1 border-t border-[#E5E7EB]"></div>
          <button type="button" class="w-full text-left px-4 py-2.5 hover:bg-[#F9FAFB]" data-menu-action="mark-resolved" data-id="${x.id}">
            Marcar como resuelto
          </button>
          <button type="button" class="w-full text-left px-4 py-2.5 hover:bg-[#F9FAFB]" data-menu-action="mark-fp" data-id="${x.id}">
            Marcar como falso positivo
          </button>
        `;

        tdAction.append(btn, menu);

        tr.append(tdScore, tdType, tdEntity, tdDesc, tdServer, tdDate, tdStatus, tdAction);
        tbody.appendChild(tr);
      });
    };

    // Pagination
    const pageWindow = (current, total) => {
      const out = [];
      const add = (x) => out.push(x);
      const pushRange = (a, b) => { for (let i = a; i <= b; i++) add(i); };
      if (total <= 9) { pushRange(1, total); return out; }
      add(1);
      const left = Math.max(2, current - 2);
      const right = Math.min(total - 1, current + 2);
      if (left > 2) add("…");
      pushRange(left, right);
      if (right < total - 1) add("…");
      add(total);
      return out;
    };

    const renderPagination = () => {
      if (!pagination) return;
      pagination.innerHTML = "";

      const items = pageWindow(state.page, state.pages);

      items.forEach((x) => {
        if (x === "…") {
          const span = document.createElement("span");
          span.className = "px-2 text-[12px] text-[#6B7280]";
          span.textContent = "…";
          pagination.appendChild(span);
          return;
        }
        const n = Number(x);
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className =
          "min-w-[34px] px-2 py-1.5 rounded-full border text-[12px] " +
          (n === state.page
            ? "border-[#111827] text-[#111827]"
            : "border-[#E5E7EB] text-[#374151] hover:bg-[#F3F4F6]");
        btn.textContent = String(n);
        btn.addEventListener("click", () => { state.page = n; render(); });
        pagination.appendChild(btn);
      });

      if (prevBtn) prevBtn.disabled = state.page <= 1;
      if (nextBtn) nextBtn.disabled = state.page >= state.pages;
    };

    const render = () => {
      const sorted = currentFilteredRows.slice().sort((a, b) => {
        const ta = Date.parse(a.datetimeISO || "") || 0;
        const tb = Date.parse(b.datetimeISO || "") || 0;
        return tb - ta;
      });

      renderKpis(sorted);

      state.total = sorted.length;
      state.pages = Math.max(1, Math.ceil(state.total / LIMIT));
      state.page = Math.min(state.page, state.pages);

      const start = (state.page - 1) * LIMIT;
      const pageItems = sorted.slice(start, start + LIMIT);

      renderTable(pageItems);
      renderPagination();
    };

    prevBtn?.addEventListener("click", () => { if (state.page > 1) { state.page -= 1; render(); }});
    nextBtn?.addEventListener("click", () => { if (state.page < state.pages) { state.page += 1; render(); }});

    // Status pills
    const statusBtns = Array.from(document.querySelectorAll("[data-incident-status-filter]"));
    const setStatusPillActive = (value) => {
      statusBtns.forEach((btn) => {
        const isActive = btn.getAttribute("data-incident-status-filter") === value;
        btn.classList.remove(
          "bg-white","text-[#374151]","border-[#E5E7EB]","hover:bg-[#F9FAFB]",
          "bg-[#111827]","text-white","border-[#111827]","hover:bg-[#1F2937]"
        );
        if (isActive) btn.classList.add("bg-[#111827]","text-white","border-[#111827]","hover:bg-[#1F2937]");
        else btn.classList.add("bg-white","text-[#374151]","border-[#E5E7EB]","hover:bg-[#F9FAFB]");
      });
    };

    // Load incidents
    const buildQueryParams = (filters) => {
      const params = new URLSearchParams();
      if (filters.server && filters.server !== "all") params.set("server", filters.server);
      if (filters.severity && filters.severity !== "all") params.set("severity", filters.severity);
      if (filters.status && filters.status !== "all") params.set("status", filters.status);

      if (filters.dateRange === "1d") params.set("days", "1");
      else if (filters.dateRange === "7d") params.set("days", "7");
      else if (filters.dateRange === "30d") params.set("days", "30");
      else params.set("days", "7");

      params.set("limit", "1000");
      params.set("offset", "0");
      return params;
    };

    const loadIncidents = async (filters) => {
      const params = buildQueryParams(filters);
      const res = await fetch(`${API_BASE}/incidents?${params.toString()}`, { headers: authHeaders() });
      if (!res.ok) {
        console.error("Error cargando /incidents:", await res.text());
        return;
      }
      const data = await res.json();
      const items = Array.isArray(data.items) ? data.items : [];
      allRows = items.map(normalizeIncident);
      currentFilteredRows = allRows.slice();
      state.page = 1;
      render();
    };

    // Click handlers
    document.addEventListener("click", (event) => {
      const target = event.target;
      if (!(target instanceof HTMLElement)) return;

      const statusBtn = target.closest("[data-incident-status-filter]");
      if (statusBtn) {
        const v = statusBtn.getAttribute("data-incident-status-filter") || "all";
        activeFilters.status = v;
        setStatusPillActive(v);
        state.page = 1;
        loadIncidents(activeFilters).catch(console.error);
        return;
      }
    });

    window.addEventListener("sentinelx:filters-changed", (event) => {
      const detail = event.detail || {};
      activeFilters = { ...activeFilters, ...detail };
      state.page = 1;
      loadIncidents(activeFilters).catch(console.error);
    });

    // ✅ Si el header manda status="all", lo forzamos a open al iniciar
    const initialFilters =
      // @ts-ignore
      window.SENTINELX_CURRENT_FILTERS || activeFilters;

    activeFilters = { ...activeFilters, ...initialFilters };

    // ✅ forzar default a pendientes si viene vacío o "all"
    if (!activeFilters.status || activeFilters.status === "all") {
      activeFilters.status = "open";
    }

    // ✅ pintar pill correcto antes de cargar
    setStatusPillActive(activeFilters.status);

    loadIncidents(activeFilters).catch(console.error);
  </script>
</DashboardLayout>

