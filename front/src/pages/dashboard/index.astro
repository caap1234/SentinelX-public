---
import DashboardLayout from "../../layouts/DashboardLayout.astro";
import HeaderBar from "../../components/dashboard/HeaderBar.astro";
import StatsCard from "../../components/dashboard/StatsCard.astro";
import ActivityChart from "../../components/dashboard/ActivityChart.astro";
import SuspiciousIPsCard from "../../components/dashboard/SuspiciousIPsCard.astro";
import RecentEventsCard from "../../components/dashboard/RecentEventsCard.astro";
import SystemStatusCard from "../../components/dashboard/SystemStatusCard.astro";

const API_BASE = import.meta.env.PUBLIC_API_URL || "http://127.0.0.1:8000";
---

<DashboardLayout>
  <HeaderBar
    title="Dashboard"
    subtitle="Visión general de alertas, incidentes y entidades en SentinelX SIEM (v2)."
    showFilters={true}
    showServerFilter={true}
    showDateFilter={true}
    showSeverityFilter={true}
  />

  <section class="flex-1 px-8 py-6 space-y-6">
    <!-- Métricas principales -->
    <div class="grid gap-4 md:grid-cols-4">
      <StatsCard
        statKey="alerts_high_critical"
        label="Alertas críticas/altas"
        value="—"
        helper="En el rango"
      />
      <StatsCard
        statKey="alerts_open"
        label="Alertas abiertas"
        value="—"
        helper="Pendientes"
      />
      <StatsCard
        statKey="incidents_active"
        label="Incidentes activos"
        value="—"
        helper="Open/Triage/Contained"
      />
      <StatsCard
        statKey="entities_risky"
        label="Entidades en riesgo"
        value="—"
        helper="Score ≥ 30"
      />
    </div>

    <!-- Dos columnas principales -->
    <div class="grid gap-4 md:grid-cols-2">
      <div class="flex flex-col gap-4">
        <ActivityChart />
        <RecentEventsCard />
      </div>

      <div class="flex flex-col gap-4">
        <SuspiciousIPsCard />
        <SystemStatusCard />
      </div>
    </div>
  </section>

  <script type="module" define:vars={{ API_BASE }}>
    // @ts-ignore
    const TOKEN = window.SENTINELX_TOKEN || null;

    /**
     * @param {{server:string; dateRange:string; severity:string; rangeFrom?:string|null; rangeTo?:string|null}} filters
     */
    function buildQueryParams(filters) {
      const params = new URLSearchParams();

      if (filters.server && filters.server !== "all") {
        params.set("server", filters.server);
      }

      if (filters.dateRange === "1d") {
        params.set("days", "1");
      } else if (filters.dateRange === "7d") {
        params.set("days", "7");
      } else if (filters.dateRange === "30d") {
        params.set("days", "30");
      } else if (filters.dateRange === "range" && filters.rangeFrom && filters.rangeTo) {
        params.set("from", filters.rangeFrom);
        params.set("to", filters.rangeTo);
      } else {
        params.set("days", "7");
      }

      if (filters.severity && filters.severity !== "all") {
        params.set("severity", filters.severity);
      }

      return params;
    }

    async function loadKpis(filters) {
      const params = buildQueryParams(filters);

      const res = await fetch(`${API_BASE}/dashboard/kpis?${params.toString()}`, {
        headers: TOKEN
          ? { Authorization: `Bearer ${TOKEN}`, Accept: "application/json" }
          : { Accept: "application/json" },
      });

      if (!res.ok) {
        console.error("Error cargando /dashboard/kpis:", await res.text());
        return;
      }

      const data = await res.json();

      /** @type {{key:string; value:number|string; helper?:string;}[]} */
      const stats = [
        {
          key: "alerts_high_critical",
          value: data.alerts?.high_critical ?? 0,
          helper: "En el rango",
        },
        {
          key: "alerts_open",
          value: data.alerts?.open ?? 0,
          helper: "Pendientes",
        },
        {
          key: "incidents_active",
          value: data.incidents?.active ?? 0,
          helper: "Open/Triage/Contained",
        },
        {
          key: "entities_risky",
          value: data.entities?.risky ?? 0,
          helper: "Score ≥ 30",
        },
      ];

      stats.forEach((item) => {
        const el = document.querySelector(`[data-stat-key="${item.key}"]`);
        if (!el) return;

        const valueEl = el.querySelector("[data-stat-value]");
        const helperEl = el.querySelector("[data-stat-helper]");

        if (valueEl) {
          const v =
            typeof item.value === "number"
              ? item.value.toLocaleString("es-MX")
              : String(item.value ?? "—");
          valueEl.textContent = v;
        }

        if (helperEl && item.helper) {
          helperEl.textContent = item.helper;
        }
      });
    }

    function getInitialFilters() {
      // @ts-ignore
      return (
        window.SENTINELX_CURRENT_FILTERS || {
          server: "all",
          dateRange: "7d",
          severity: "all",
          rangeFrom: null,
          rangeTo: null,
        }
      );
    }

    loadKpis(getInitialFilters()).catch((e) =>
      console.error("Error inicial KPIs:", e)
    );

    window.addEventListener("sentinelx:filters-changed", (ev) => {
      // @ts-ignore
      const filters = ev.detail;
      loadKpis(filters).catch((e) =>
        console.error("Error recargando KPIs:", e)
      );
    });
  </script>
</DashboardLayout>
