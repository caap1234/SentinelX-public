# docker-compose.example.yml
services:
  db:
    image: postgres:16
    container_name: sentinelx-db
    shm_size: "1g"
    restart: unless-stopped

    environment:
      POSTGRES_DB: ${POSTGRES_DB:-sentinelx_db}
      POSTGRES_USER: ${POSTGRES_USER:-sentinelx}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_INITDB_ARGS: ${POSTGRES_INITDB_ARGS:---data-checksums}

    ports:
      - "${POSTGRES_PORT:-5432}:5432"

    volumes:
      - pgdata:/var/lib/postgresql/data
      # opcional: init scripts (si existen en tu repo)
      - ./postgres/init:/docker-entrypoint-initdb.d:ro

    stop_signal: SIGINT
    stop_grace_period: 2m

    command: >
      postgres
      -c shared_buffers=${PG_SHARED_BUFFERS:-256MB}
      -c wal_compression=${PG_WAL_COMPRESSION:-on}
      -c max_wal_size=${PG_MAX_WAL_SIZE:-2GB}
      -c checkpoint_timeout=${PG_CHECKPOINT_TIMEOUT:-10min}
      -c checkpoint_completion_target=${PG_CHECKPOINT_COMPLETION_TARGET:-0.9}
      -c log_checkpoints=${PG_LOG_CHECKPOINTS:-on}
      -c log_min_duration_statement=${PG_LOG_MIN_DURATION_STATEMENT:-2000}
      -c log_line_prefix='${PG_LOG_LINE_PREFIX:-%m[%p] user=%u db=%d app=%a client=%h }'
      -c idle_in_transaction_session_timeout=${PG_IDLE_TX_TIMEOUT_MS:-300000}
      -c statement_timeout=${PG_STATEMENT_TIMEOUT_MS:-0}
      -c shared_preload_libraries=${PG_SHARED_PRELOAD_LIBS:-pg_stat_statements}
      -c pg_stat_statements.track=${PGSS_TRACK:-all}
      -c pg_stat_statements.max=${PGSS_MAX:-10000}
      -c pg_stat_statements.save=${PGSS_SAVE:-on}

    logging:
      driver: "json-file"
      options:
        max-size: "${LOG_MAX_SIZE:-50m}"
        max-file: "${LOG_MAX_FILE:-5}"

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-sentinelx} -d ${POSTGRES_DB:-sentinelx_db} -h 127.0.0.1 || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 20
      start_period: 20s

    tmpfs:
      - /tmp

    ulimits:
      nofile:
        soft: 65536
        hard: 65536

  backend:
    build:
      context: .
    container_name: sentinelx-backend
    restart: unless-stopped

    depends_on:
      db:
        condition: service_healthy

    env_file:
      - .env

    environment:
      # DB_PASSWORD_URLENC debe ir URL-encoded (ej: & => %26)
      DATABASE_URL: "postgresql+psycopg2://${POSTGRES_USER:-sentinelx}:${DB_PASSWORD_URLENC}@db:5432/${POSTGRES_DB:-sentinelx_db}"

      UPLOADED_LOGS_DIR: ${UPLOADED_LOGS_DIR:-/app/uploaded_logs}

      GEOIP_COUNTRY_DB_PATH: ${GEOIP_COUNTRY_DB_PATH:-/geoip/GeoLite2-Country.mmdb}
      GEOIP_ASN_DB_PATH: ${GEOIP_ASN_DB_PATH:-/geoip/GeoLite2-ASN.mmdb}

      ENRICH_INLINE: "${ENRICH_INLINE:-1}"
      ENRICH_CACHE_TTL: "${ENRICH_CACHE_TTL:-86400}"
      ENRICH_CACHE_MAX: "${ENRICH_CACHE_MAX:-100000}"
      RULES_RELOAD_SECONDS: "${RULES_RELOAD_SECONDS:-600}"

      # SMTP (se recomienda meterlo en .env)
      SMTP_HOST: "${SMTP_HOST}"
      SMTP_PORT: "${SMTP_PORT:-587}"
      SMTP_USER: "${SMTP_USER}"
      SMTP_PASS: "${SMTP_PASS}"
      FROM_EMAIL: "${FROM_EMAIL}"
      SMTP_TIMEOUT_SECONDS: "${SMTP_TIMEOUT_SECONDS:-20}"

      FRONTEND_BASE_URL: "${FRONTEND_BASE_URL:-http://localhost:4321}"

    # Caso cPanel + Docker (SMTP en el mismo VPS):
    # Mapea el dominio a la IP "host gateway" (en tu caso 172.17.0.1),
    # o usa "host-gateway" si tu docker lo soporta.
    extra_hosts:
      - "${SENTINELX_SMTP_HOST_ALIAS:-sentinelx.tokyo-03.com}:${SENTINELX_SMTP_HOST_IP:-172.17.0.1}"

    ports:
      - "${BACKEND_PORT:-8000}:8000"

    volumes:
      - .:/app
      - ./geoip:/geoip:ro
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro

    stop_grace_period: 1m

    command: >
      bash -lc "alembic upgrade head && uvicorn app.main:app --host 0.0.0.0 --port 8000"

    logging:
      driver: "json-file"
      options:
        max-size: "${LOG_MAX_SIZE:-50m}"
        max-file: "${LOG_MAX_FILE:-5}"

  parsing_worker:
    build:
      context: .
    restart: unless-stopped

    depends_on:
      db:
        condition: service_healthy

    env_file:
      - .env

    environment:
      DATABASE_URL: "postgresql+psycopg2://${POSTGRES_USER:-sentinelx}:${DB_PASSWORD_URLENC}@db:5432/${POSTGRES_DB:-sentinelx_db}"

      UPLOADED_LOGS_DIR: ${UPLOADED_LOGS_DIR:-/app/uploaded_logs}

      GEOIP_COUNTRY_DB_PATH: ${GEOIP_COUNTRY_DB_PATH:-/geoip/GeoLite2-Country.mmdb}
      GEOIP_ASN_DB_PATH: ${GEOIP_ASN_DB_PATH:-/geoip/GeoLite2-ASN.mmdb}

      ENRICH_INLINE: "${ENRICH_INLINE:-1}"
      ENRICH_CACHE_TTL: "${ENRICH_CACHE_TTL:-86400}"
      ENRICH_CACHE_MAX: "${ENRICH_CACHE_MAX:-100000}"
      RULES_RELOAD_SECONDS: "${RULES_RELOAD_SECONDS:-600}"

      WORKER_POLL_SECONDS: "${WORKER_POLL_SECONDS:-2}"
      WORKER_MAX_PER_CYCLE: "${WORKER_MAX_PER_CYCLE:-1}"
      WORKER_STALE_SECONDS: "${WORKER_STALE_SECONDS:-3600}"

      # SMTP (por si quieres notificar desde parsing tambiÃ©n)
      SMTP_HOST: "${SMTP_HOST}"
      SMTP_PORT: "${SMTP_PORT:-587}"
      SMTP_USER: "${SMTP_USER}"
      SMTP_PASS: "${SMTP_PASS}"
      FROM_EMAIL: "${FROM_EMAIL}"
      SMTP_TIMEOUT_SECONDS: "${SMTP_TIMEOUT_SECONDS:-20}"

      FRONTEND_BASE_URL: "${FRONTEND_BASE_URL:-http://localhost:4321}"

    extra_hosts:
      - "${SENTINELX_SMTP_HOST_ALIAS:-sentinelx.tokyo-03.com}:${SENTINELX_SMTP_HOST_IP:-172.17.0.1}"

    volumes:
      - .:/app
      - ./geoip:/geoip:ro
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro

    stop_grace_period: 1m

    command: >
      bash -lc "python -m app.workers.parsing_worker_loop"

    logging:
      driver: "json-file"
      options:
        max-size: "${LOG_MAX_SIZE:-50m}"
        max-file: "${LOG_MAX_FILE:-5}"

  engine_worker:
    build:
      context: .
    restart: unless-stopped

    depends_on:
      db:
        condition: service_healthy

    env_file:
      - .env

    environment:
      DATABASE_URL: "postgresql+psycopg2://${POSTGRES_USER:-sentinelx}:${DB_PASSWORD_URLENC}@db:5432/${POSTGRES_DB:-sentinelx_db}"

      GEOIP_COUNTRY_DB_PATH: ${GEOIP_COUNTRY_DB_PATH:-/geoip/GeoLite2-Country.mmdb}
      GEOIP_ASN_DB_PATH: ${GEOIP_ASN_DB_PATH:-/geoip/GeoLite2-ASN.mmdb}

      RULES_RELOAD_SECONDS: "${RULES_RELOAD_SECONDS:-600}"

      ENGINE_WORKER_POLL_SECONDS: "${ENGINE_WORKER_POLL_SECONDS:-1}"
      ENGINE_WORKER_MAX_PER_CYCLE: "${ENGINE_WORKER_MAX_PER_CYCLE:-200}"
      ENGINE_WORKER_STALE_SECONDS: "${ENGINE_WORKER_STALE_SECONDS:-3600}"

      # SMTP (para alertas)
      SMTP_HOST: "${SMTP_HOST}"
      SMTP_PORT: "${SMTP_PORT:-587}"
      SMTP_USER: "${SMTP_USER}"
      SMTP_PASS: "${SMTP_PASS}"
      FROM_EMAIL: "${FROM_EMAIL}"
      SMTP_TIMEOUT_SECONDS: "${SMTP_TIMEOUT_SECONDS:-20}"

      FRONTEND_BASE_URL: "${FRONTEND_BASE_URL:-http://localhost:4321}"

    extra_hosts:
      - "${SENTINELX_SMTP_HOST_ALIAS:-sentinelx.tokyo-03.com}:${SENTINELX_SMTP_HOST_IP:-172.17.0.1}"

    volumes:
      - .:/app
      - ./geoip:/geoip:ro
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro

    stop_grace_period: 1m

    command: >
      bash -lc "python -m app.workers.engine_worker_loop"

    logging:
      driver: "json-file"
      options:
        max-size: "${LOG_MAX_SIZE:-50m}"
        max-file: "${LOG_MAX_FILE:-5}"

volumes:
  pgdata:

